
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>إدارة المديونيات — مخصصات محسّنة + صلاحيات متعددة + تجميد مستخدم</title>
<link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
:root{
  --primary:#0b3a8a; --accent:#ffd83a; --bg-grad: linear-gradient(135deg,#071735 0%, #0b2b6f 100%);
  --glass: rgba(255,255,255,0.08); --card-w: 340px; --radius: 16px; --gray-card: #f3f4f6;
  --green:#2ecc71; --orange:#f59e0b; --yellow:#ffd83a;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Almarai',sans-serif;background:var(--bg-grad);color:#fff;min-height:100vh;padding:18px}

/* login */
#loginScreen{display:flex;align-items:center;justify-content:center;height:calc(100vh - 36px);padding:20px}
.login-card{width:380px;padding:28px;border-radius:14px;background:var(--glass);backdrop-filter:blur(8px);box-shadow:0 10px 40px rgba(2,6,23,0.6);text-align:center}
.login-card h1{margin:0 0 10px;font-size:20px}
.input{width:100%;padding:11px 13px;margin:8px 0;border-radius:10px;border:1px solid rgba(255,255,255,0.35);font-size:14px;text-align:center;background:rgba(255,255,255,0.12);color:#fff}
.input::placeholder{color:#eef2ff}
.btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--accent),#f0c032);color:#000;box-shadow:0 8px 24px rgba(0,0,0,0.25)}
.btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.3)}
.btn.block{width:100%}

/* app */
#app{display:none;padding:16px;max-width:1600px;margin:8px auto}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:14px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:50px;height:50px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#00204a);display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,0.35)}
.brand h2{margin:0;font-size:17px}
.controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
.top-btn{padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:transparent;color:#fff;white-space:nowrap;font-size:13px}
.top-btn.primary{background:rgba(255,255,255,0.06);box-shadow:inset 0 -2px 0 rgba(0,0,0,0.08)}
.top-btn.action{background:linear-gradient(90deg,var(--accent),#f0c032);color:#000}
.search-wrap{display:flex;align-items:center;gap:6px}
.search-input{width:220px;padding:7px;border-radius:10px;border:1px solid rgba(255,255,255,0.35);background:rgba(255,255,255,0.12);color:#fff;display:none}

/* selects */
.select{background:#fff !important;color:#111 !important;padding:8px 10px;border-radius:10px;border:1px solid #ddd;min-width:150px;text-align:center;appearance:auto;font-size:13px}
select option{background:#fff;color:#111}
select:focus{outline:2px solid #c7d2fe}

/* filters */
.filters{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}

/* grid */
.grid{display:grid;grid-template-columns:repeat(5,minmax(var(--card-w),1fr));gap:16px;justify-items:center;align-items:start;padding-bottom:16px}

/* card */
.card{
  position:relative;width:var(--card-w);
  background:linear-gradient(180deg,var(--gray-card),#ffffffee);
  border-radius:var(--radius);color:#000;box-shadow:0 10px 26px rgba(2,6,23,0.18);
  overflow:hidden;display:flex;flex-direction:column;justify-content:flex-start;padding:0;transition:transform .18s, box-shadow .18s
}
.card:hover{transform:translateY(-4px);box-shadow:0 14px 34px rgba(2,6,23,0.22)}
.mall-bar{height:6px;width:100%}
.mall-bar.bottom{margin-top:8px}
.value-line{border-radius:8px;padding:6px 8px;text-align:center;font-weight:800;color:#fff;margin:6px 10px;font-size:13px;line-height:1.25}
.value-line.yellow-text{color:var(--yellow); border:1px dashed rgba(255,216,58,0.6)}
.value-line.white-text{color:#fff; border:1px dashed rgba(255,255,255,0.45)}

/* status */
.status{display:inline-block;padding:5px 8px;border-radius:10px;font-weight:800;margin:2px 3px;font-size:12px}
.status.pending{background:#ffd83a;color:#000}
.status.late{background:#e53935;color:#fff}
.status.paid{background:#2ecc71;color:#fff}
.status.approval-pending{background:#9ca3af;color:#111}
.status.approved{background:#2563eb;color:#fff}
.status.cancelled{background:#6b7280;color:#fff}

.card-body{padding:10px 6px 2px 6px}
.card-footer{display:flex;gap:6px;justify-content:center;align-items:center;padding:6px 10px 10px}

/* kebab */
.kebab{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.6);color:#fff;border:none;border-radius:999px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:6}
.menu{position:absolute;top:40px;right:6px;background:#111;color:#fff;border:1px solid rgba(255,255,255,0.15);border-radius:10px;min-width:300px;box-shadow:0 10px 30px rgba(0,0,0,0.4);display:none;z-index:7}
.menu.open{display:block}
.menu button{width:100%;text-align:right;background:transparent;color:#fff;border:none;padding:9px 10px;cursor:pointer;font-size:13px}
.menu button:hover{background:#1f2937}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:960px;max-width:95vw;background:var(--glass);padding:16px;border-radius:14px;backdrop-filter:blur(10px);box-shadow:0 18px 60px rgba(0,0,0,0.45)}
.modal h3{margin:0 0 8px;color:#fff}
.modal h4{margin:8px 0 6px}
.modal .row{display:flex;gap:8px;margin:6px 0;align-items:center}
.modal input,.modal select,.modal textarea{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.45);background:rgba(255,255,255,0.14);color:#fff;font-weight:700;font-size:13px}
.modal input::placeholder,.modal textarea::placeholder{color:#eef2ff}

/* budget grid new */
.sec-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
.sec-card{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:8px}
.sec-title{font-weight:800;margin-bottom:6px}
.sec-foot{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:12px;opacity:.9}

/* admin tags */
.tag{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);padding:4px 8px;border-radius:999px;margin:4px 6px 0 0}
.tag button{background:transparent;border:none;color:#fff;cursor:pointer}

.admin-item{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.08);padding:8px 10px;border-radius:10px;margin:6px 0}
.small-note{opacity:.9}

/* responsive */
@media(max-width:1400px){.grid{grid-template-columns:repeat(4,minmax(260px,1fr))}}
@media(max-width:1100px){.grid{grid-template-columns:repeat(3,minmax(240px,1fr))}}
@media(max-width:820px){.grid{grid-template-columns:repeat(2,minmax(220px,1fr))}}
@media(max-width:720px){
  .login-card{width:92%}.modal{width:92%}.grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .sec-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <h1>شاشة ادارة المديونيات</h1>
    <p class="small-note">سجل الدخول</p>
    <input id="inputUser" class="input" placeholder="اسم المستخدم">
    <input id="inputPass" type="password" class="input" placeholder="كلمة المرور">
    <button class="btn block" id="btnLogin">دخول</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="topbar">
    <div class="brand">
      <div class="logo">ن</div>
      <div>
        <h2 id="welcomeTitle">مرحباً</h2>
        <div class="small-note" id="roleLabel">الصلاحية</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:10px">
      <div class="search-wrap">
        <input id="searchInput" class="search-input" placeholder="ابحث عن مورد / مركز / قسم">
        <button class="top-btn" id="btnSearchToggle" title="بحث"><i class="fa fa-search"></i></button>
      </div>
      <div class="controls" style="margin-left:auto">
        <button class="top-btn primary" id="btnShowCards"><i class="fa fa-th-large"></i> الكروت</button>
        <button class="top-btn action" id="btnShowAdd"><i class="fa fa-plus-circle"></i> ترحيل طلب جديد</button>
        <button class="top-btn primary" id="btnBudgets" style="display:none"><i class="fa fa-sack-dollar"></i> مخصصات الأقسام</button>
        <button class="top-btn primary" id="btnAdmin" style="display:none"><i class="fa fa-user-gear"></i> لوحة التحكم</button>
        <button class="top-btn" id="btnLogout"><i class="fa fa-sign-out-alt"></i> خروج</button>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <select id="filterMall" class="select">
      <option value="">كل المولات</option>
      <option>الانصار مول</option>
      <option>ابيات عسير</option>
      <option>فور بارك</option>
      <option>العرب بلازا</option>
    </select>
    <select id="filterSection" class="select">
      <option value="">كل الأقسام</option>
    </select>
    <select id="filterSupplier" class="select"><option value="">كل الموردين</option></select>
    <select id="filterStatus" class="select">
      <option value="">كل الحالات</option>
      <option value="pending">مستحقة</option><option value="late">متأخر</option><option value="paid">مسدد</option>
      <option value="approval_pending">بانتظار الموافقة</option><option value="approved">معتمدة</option><option value="cancelled">ملغاة</option>
    </select>
    <input id="filterMonth" type="month" class="select" style="min-width:170px" />
    <label style="display:flex;align-items:center;gap:6px">
      <input type="checkbox" id="filterHasDiscount"> يحتوي خصم مكتسب
    </label>
  </div>

  <!-- Cards -->
  <div class="grid" id="cardsGrid"></div>
</div>

<!-- ===== Budget Modal (Improved) ===== -->
<div class="modal-backdrop" id="modalBudget">
  <div class="modal">
    <h3><i class="fa fa-sack-dollar"></i> مخصصات الأقسام المالية</h3>
    <div class="row">
      <select id="budMall" class="select" title="المركز"></select>
      <select id="budMonth" class="select" title="الشهر"></select>
      <button class="btn" id="budLoad"><i class="fa fa-list"></i> تحميل الأقسام</button>
      <button class="btn" id="budCopyPrev"><i class="fa fa-copy"></i> نسخ من الشهر السابق</button>
      <button class="btn" id="budFillBulk"><i class="fa fa-bolt"></i> تعبئة جماعية</button>
    </div>
    <div id="budSecGrid" class="sec-grid"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="budSave"><i class="fa fa-save"></i> حفظ</button>
      <button class="btn ghost" id="budClose">إغلاق</button>
    </div>
    <p class="small-note">لكل قسم: أدخل المبلغ وحدد الاعتماد (يمكن ترك بعض الأقسام صفر/غير معتمد).</p>
  </div>
</div>

<!-- ===== Add Debt Modal ===== -->
<div class="modal-backdrop" id="modalAdd">
  <div class="modal">
    <h3>ترحيل طلب جديد</h3>
    <div class="row">
      <select id="addMall" class="select"></select>
      <select id="addSection" class="select"></select>
    </div>
    <div class="row">
      <select id="addSupplier" class="select"><option>اختر المورد</option></select>
      <select id="addTransferKind" class="select" title="نوع التحويل">
        <option>مقدم</option><option>مستحق</option><option>تسوية نهائية</option>
      </select>
    </div>
    <div class="row">
      <input id="addAmount" class="input" type="number" placeholder="المبلغ">
      <input id="addDiscount" class="input" type="number" placeholder="الخصم المكتسب">
      <input id="addDue" class="input" type="date" title="تاريخ الاستحقاق">
    </div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="addSave">حفظ</button>
      <button class="btn ghost" id="addCancel">إلغاء</button>
    </div>
    <p class="small-note" id="addBudgetNote"></p>
  </div>
</div>

<!-- ===== Admin Modal (Improved Users) ===== -->
<div class="modal-backdrop" id="modalAdmin">
  <div class="modal">
    <h3><i class="fa fa-user-gear"></i> لوحة التحكم</h3>

    <!-- إضافة مستخدم -->
    <h4>إضافة مستخدم جديد</h4>
    <div class="row">
      <input id="adminUserName" class="input" type="text" placeholder="اسم المستخدم">
      <input id="adminUserPass" class="input" type="password" placeholder="كلمة المرور">
      <select id="adminUserRole" class="select" title="الصلاحية">
        <option value="admin">إدارة تنفيذية</option>
        <option value="accountant">ادارة مالية </option>
        <option value="special">مشرف قسم</option>
        <option value="viewer">إستعلام</option>
      </select>
    </div>

    <!-- تعيينات المشرف -->
    <div id="specialAssignWrap" style="display:none">
      <div class="row">
        <select id="assignMall" class="select" title="المركز"></select>
        <select id="assignSection" class="select" title="القسم"></select>
        <button class="btn" id="assignAdd"><i class="fa fa-plus"></i> إضافة تعيين</button>
      </div>
      <div id="assignTags"></div>
    </div>

    <div class="row"><button class="btn" id="adminAddUser"><i class="fa fa-user-plus"></i> حفظ المستخدم</button></div>

    <hr style="border-color:rgba(255,255,255,0.2)">

    <!-- إضافة مورد -->
    <h4>إضافة موردين</h4>
    <div class="row">
      <select id="adminSupMall" class="select" title="المركز"></select>
      <select id="adminSupSection" class="select" title="القسم"></select>
    </div>
    <div class="row">
      <textarea id="adminSuppliersText" class="input" style="height:110px;text-align:right" placeholder="كل مورد بسطر مستقل"></textarea>
    </div>
    <div class="row"><button class="btn" id="adminAddSuppliers"><i class="fa fa-plus"></i> إضافة المورد/الموردين</button></div>

    <p class="small-note">المستخدمون والموردون يُحفظون محليًا في هذا المتصفح.</p>
    <div id="adminUsersList"></div>

    <div class="row" style="justify-content:flex-end">
      <button class="btn ghost" id="adminClose">إغلاق</button>
    </div>
  </div>
</div>

<!-- ===== Approve Extras Modal ===== -->
<div class="modal-backdrop" id="modalApproveExtras">
  <div class="modal">
    <h3>إدخال بعد الاعتماد</h3>
    <div class="row">
      <input id="apSupplierDebt" class="input" type="number" placeholder="رصيد مديونية المورد (اختياري)">
      <select id="apPriority" class="select">
        <option value="">بدون تحديد</option>
        <option>أولوية عادية</option>
        <option>أولوية مرتفعة</option>
      </select>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="apSave">حفظ</button>
      <button class="btn ghost" id="apCancel">إغلاق</button>
    </div>
  </div>
</div>

<script>
/* ======= ثابت ======= */
const SESSION_KEY='pos_session_user_v1';

/* ======= تعريف المراكز والأقسام ======= */
const MALL_SECTIONS = {
  "الانصار مول": ["الرجالي","النسائي","الولادي","الرياضة","الجاكت","التخفيضات","المفروشات","المنزلية","الاحذية","العطور","سيفورا","المكتبة","الشنط","الالعاب","المواليد"],
  "ابيات عسير": ["الرجالي","النسائي","الولادي","المواليد","العطور","الالعاب","الاحذية","المفروشات","المنزلية"],
  "فور بارك": ["المفروشات","المنزلية"],
  "العرب بلازا": ["المفروشات","المنزلية","الالعاب"]
};

/* ======= المستخدمون ======= */
const USERS_LS_KEY='pos_users_dynamic_v3';
/*
 user object:
 { pass, role, canAdd, canPay, isEnabled, assignments?: [ {mall, section}, ... ] }
*/
const BASE_USERS={
  "نصر":{pass:"71111",role:"admin",canAdd:true,canPay:true,isEnabled:true},
  "مصطفى":{pass:"123456",role:"accountant",canAdd:false,canPay:true,isEnabled:true},
  "استعلام":{pass:"123456",role:"viewer",canAdd:false,canPay:false,isEnabled:true},
  "جياب":{pass:"71111",role:"special",canAdd:true,canPay:false,isEnabled:true,assignments:[{mall:"الانصار مول",section:"المنزلية"}]},
  "راجح":{pass:"73333",role:"special",canAdd:true,canPay:false,isEnabled:true,assignments:[{mall:"الانصار مول",section:"المفروشات"}]},
  "العطور":{pass:"81111",role:"special",canAdd:true,canPay:false,isEnabled:true,assignments:[{mall:"الانصار مول",section:"العطور"}]}
};
function loadDynamicUsers(){try{return JSON.parse(localStorage.getItem(USERS_LS_KEY)||'{}')}catch(e){return{}}}
function saveDynamicUsers(o){localStorage.setItem(USERS_LS_KEY,JSON.stringify(o||{}))}
let USERS={...BASE_USERS,...loadDynamicUsers()};

/* ======= الموردون ======= */
const SUPPLIERS_LS_KEY='pos_suppliers_by_mall_section_v1';
function loadSuppliers(){ try{return JSON.parse(localStorage.getItem(SUPPLIERS_LS_KEY)||'{}')}catch(e){return{}} }
function saveSuppliers(o){ localStorage.setItem(SUPPLIERS_LS_KEY, JSON.stringify(o||{})); }
let SUPPLIERS = loadSuppliers();
if(Object.keys(SUPPLIERS).length===0){
  SUPPLIERS={"الانصار مول":{"المفروشات":["شركة زهرة بيسان"],"المنزلية":["شركة السيف"],"العطور":["مؤسسة دار سمائل"]},
             "ابيات عسير":{"المنزلية":["شركة ريفان"],"المفروشات":["شموع الجزيرة"]},
             "فور بارك":{"المنزلية":["بيتك الذهبي"]},
             "العرب بلازا":{"المفروشات":["روائع النسيج"]}};
  saveSuppliers(SUPPLIERS);
}

/* ======= المخصصات ======= */
const BUDGET_LS_KEY='pos_section_budgets_v9';
/* structure:
{
  "YYYY-MM": {
    "الانصار مول": {
      "المفروشات": {amount:100000,consumed:0,approved:true},
      ...
    },
    ...
  }
}
*/
function loadBudgets(){ try{return JSON.parse(localStorage.getItem(BUDGET_LS_KEY)||'{}')}catch(e){return{}} }
function saveBudgets(o){ localStorage.setItem(BUDGET_LS_KEY, JSON.stringify(o||{})); }
function ensureBudget(b, ym, mall, section){
  if(!b[ym]) b[ym]={}; if(!b[ym][mall]) b[ym][mall]={};
  if(!b[ym][mall][section]) b[ym][mall][section]={amount:0,consumed:0,approved:false};
}
function setBudget(ym, mall, section, amount, approved){
  const b=loadBudgets(); ensureBudget(b,ym,mall,section);
  const prev=b[ym][mall][section]; b[ym][mall][section]={amount:Number(amount)||0,consumed:prev.consumed||0,approved:!!approved};
  saveBudgets(b);
}
function addConsumption(ym, mall, section, val){
  const b=loadBudgets(); if(!b[ym]||!b[ym][mall]||!b[ym][mall][section]) return;
  b[ym][mall][section].consumed=(b[ym][mall][section].consumed||0)+Math.max(Number(val)||0,0);
  saveBudgets(b);
}
function refundConsumption(ym, mall, section, val){
  const b=loadBudgets(); if(!b[ym]||!b[ym][mall]||!b[ym][mall][section]) return;
  const cur=b[ym][mall][section].consumed||0; b[ym][mall][section].consumed=Math.max(0, cur-Math.max(Number(val)||0,0));
  saveBudgets(b);
}
function getBudget(ym, mall, section){
  const b=loadBudgets(); const rec=(((b[ym]||{})[mall]||{})[section]); if(!rec) return null;
  return {...rec, remaining: Math.max((rec.amount||0)-(rec.consumed||0),0)};
}

/* ======= المديونيات ======= */
const LS_KEY='pos_debts_final_v17';
let debts=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
function saveDebts(){ localStorage.setItem(LS_KEY, JSON.stringify(debts)); }

/* ======= Helpers ======= */
function fmtNum(n){return Number(n||0).toLocaleString('en-US')}
function mallColor(m){ if(m==='الانصار مول') return '#03045e'; if(m==='ابيات عسير') return '#007BA7'; if(m==='فور بارك') return '#7b2cbf'; if(m==='العرب بلازا') return '#588157'; return '#6b7280';}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function currentMonthKey(){const dt=new Date();const y=dt.getFullYear();const m=String(dt.getMonth()+1).padStart(2,'0');return `${y}-${m}`;}
function monthLabel(ym){const [y,m]=ym.split('-');const names=['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];return `${names[Number(m)-1]} ${y}`;}
function netValue(d){return Math.max((Number(d.amount)||0)-(Number(d.discount)||0),0)}
function calcStatus(d){ if(d.cancelled) return {text:'ملغاة',cls:'cancelled'}; if(d.status==='paid') return {text:'مسدد',cls:'paid'}; const diff=(new Date()-new Date(d.due))/(1000*60*60*24); if(diff>7) return {text:'متأخر',cls:'late'}; return {text:'مستحقة',cls:'pending'};}
function approvalInfo(d){ if(d.cancelled) return {text:'',cls:''}; if(d.approval==='pending') return {text:'بانتظار الموافقة',cls:'approval-pending'}; if(d.approval==='approved') return {text:'معتمدة',cls:'approved'}; return {text:'',cls:''}; }
function translateRole(r){ return r==='admin'?'إدارة تنفيذية':r==='accountant'?'إدارة مالية':r==='special'?'مشرف قسم':r==='viewer'?'إستعلام':r; }

/* ======= Elements ======= */
const loginScreen=document.getElementById('loginScreen');
const appEl=document.getElementById('app');
const welcomeTitle=document.getElementById('welcomeTitle');
const roleLabel=document.getElementById('roleLabel');
const cardsGrid=document.getElementById('cardsGrid');

const btnLogin=document.getElementById('btnLogin');
const inputUser=document.getElementById('inputUser');
const inputPass=document.getElementById('inputPass');

const btnShowAdd=document.getElementById('btnShowAdd');
const btnShowCards=document.getElementById('btnShowCards');
const btnBudgets=document.getElementById('btnBudgets');
const btnAdmin=document.getElementById('btnAdmin');
const btnLogout=document.getElementById('btnLogout');

const filterMall=document.getElementById('filterMall');
const filterSection=document.getElementById('filterSection');
const filterSupplier=document.getElementById('filterSupplier');
const filterStatus=document.getElementById('filterStatus');
const filterMonth=document.getElementById('filterMonth');
const filterHasDiscount=document.getElementById('filterHasDiscount');
const searchInput=document.getElementById('searchInput');

/* Modals */
const modalBudget=document.getElementById('modalBudget');
const budMall=document.getElementById('budMall');
const budMonth=document.getElementById('budMonth');
const budLoad=document.getElementById('budLoad');
const budSecGrid=document.getElementById('budSecGrid');
const budSave=document.getElementById('budSave');
const budClose=document.getElementById('budClose');
const budCopyPrev=document.getElementById('budCopyPrev');
const budFillBulk=document.getElementById('budFillBulk');

const modalAdd=document.getElementById('modalAdd');
const addMall=document.getElementById('addMall');
const addSection=document.getElementById('addSection');
const addSupplier=document.getElementById('addSupplier');
const addTransferKind=document.getElementById('addTransferKind');
const addAmount=document.getElementById('addAmount');
const addDiscount=document.getElementById('addDiscount');
const addDue=document.getElementById('addDue');
const addSave=document.getElementById('addSave');
const addCancel=document.getElementById('addCancel');
const addBudgetNote=document.getElementById('addBudgetNote');

const modalAdmin=document.getElementById('modalAdmin');
const adminUserName=document.getElementById('adminUserName');
const adminUserPass=document.getElementById('adminUserPass');
const adminUserRole=document.getElementById('adminUserRole');
const specialAssignWrap=document.getElementById('specialAssignWrap');
const assignMall=document.getElementById('assignMall');
const assignSection=document.getElementById('assignSection');
const assignAdd=document.getElementById('assignAdd');
const assignTags=document.getElementById('assignTags');
const adminAddUser=document.getElementById('adminAddUser');
const adminSupMall=document.getElementById('adminSupMall');
const adminSupSection=document.getElementById('adminSupSection');
const adminSuppliersText=document.getElementById('adminSuppliersText');
const adminAddSuppliers=document.getElementById('adminAddSuppliers');
const adminClose=document.getElementById('adminClose');
const adminUsersList=document.getElementById('adminUsersList');

const modalApproveExtras=document.getElementById('modalApproveExtras');
const apSupplierDebt=document.getElementById('apSupplierDebt');
const apPriority=document.getElementById('apPriority');
const apSave=document.getElementById('apSave');
const apCancel=document.getElementById('apCancel');

/* ======= حالة عامة ======= */
let currentUser=null;
let searchQuery=''; 
let approveExtrasIndex=null;

/* ======= Login ======= */
btnLogin.addEventListener('click', doLogin);
inputUser.addEventListener('keydown',e=>{if(e.key==='Enter') doLogin()});
inputPass.addEventListener('keydown',e=>{if(e.key==='Enter') doLogin()});
function doLogin(){
  USERS={...BASE_USERS,...loadDynamicUsers()};
  const u=inputUser.value.trim(); const p=inputPass.value.trim();
  if(!u||!p){ alert('أدخل اسم المستخدم وكلمة المرور'); return; }
  const rec=USERS[u];
  if(rec && rec.pass===p){
    if(rec.isEnabled===false){ alert('تم تجميد هذا الحساب. الرجاء التواصل مع الإدارة.'); return; }
    currentUser={name:u,...rec};
    localStorage.setItem(SESSION_KEY,u);
    loginScreen.style.display='none'; appEl.style.display='block';
    welcomeTitle.textContent=`مرحباً، ${u}`; roleLabel.textContent=`الدور: ${translateRole(rec.role)}`;
    applyRoleFeatures();
    populateFilterSections();
    populateSupplierFilter();
    renderCards();
  }else{
    alert('اسم المستخدم أو كلمة المرور غير صحيح');
  }
}

/* ======= Logout ======= */
btnLogout.addEventListener('click', ()=>{ if(confirm('هل تريد تسجيل الخروج؟')) doLogout(); });
function doLogout(){
  currentUser=null; localStorage.removeItem(SESSION_KEY);
  inputUser.value=''; inputPass.value='';
  appEl.style.display='none'; loginScreen.style.display='flex';
}

/* ======= Top buttons ======= */
document.getElementById('btnSearchToggle').addEventListener('click', ()=>{
  searchInput.style.display = searchInput.style.display==='inline-block' ? 'none' : 'inline-block';
  if(searchInput.style.display==='inline-block') searchInput.focus(); else { searchInput.value=''; searchQuery=''; renderCards(); }
});
searchInput.addEventListener('input',e=>{ searchQuery=e.target.value.trim().toLowerCase(); renderCards(); });

btnShowAdd.addEventListener('click', openAddModal);
btnShowCards.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
btnBudgets.addEventListener('click', openBudgetModal);
btnAdmin.addEventListener('click', openAdminModal);

/* ======= Role features ======= */
function applyRoleFeatures(){
  const r=currentUser.role;
  btnShowAdd.style.display = currentUser.canAdd ? 'inline-block' : 'none';
  btnAdmin.style.display = (r==='admin' || currentUser.name==='نصر') ? 'inline-block' : 'none';
  btnBudgets.style.display = (currentUser && (currentUser.name==='نصر' || currentUser.name==='مصطفى')) ? 'inline-block' : 'none';
}

/* ======= Filters ======= */
function populateFilterSections(){
  const fs=filterSection; fs.innerHTML='';
  fs.appendChild(new Option('كل الأقسام',''));
  const all=new Set(); Object.values(MALL_SECTIONS).forEach(arr=>arr.forEach(s=>all.add(s)));
  Array.from(all).forEach(s=> fs.appendChild(new Option(s,s)));
}
filterMall.addEventListener('change',renderCards);
filterSection.addEventListener('change',renderCards);
filterSupplier.addEventListener('change',renderCards);
filterStatus.addEventListener('change',renderCards);
filterMonth.addEventListener('change',renderCards);
filterHasDiscount.addEventListener('change',renderCards);

/* ======= suppliers filter ======= */
function populateSupplierFilter(){
  const el=filterSupplier; el.innerHTML=''; el.appendChild(new Option('كل الموردين',''));
  const all=new Set();
  Object.values(SUPPLIERS).forEach(secMap=> Object.values(secMap).forEach(list=> list.forEach(s=> all.add(s))));
  Array.from(all).forEach(s=> el.appendChild(new Option(s,s)));
}

/* ======= Special assignments helpers ======= */
function getAssignments(user){
  if(!user) return [];
  if(Array.isArray(user.assignments)) return user.assignments.slice();
  // توافق قديم: لا نستخدم الآن، لكن للإكمال
  if(user.mall && user.allowedSection) return [{mall:user.mall,section:user.allowedSection}];
  return [];
}
function isVisibleForUser(d){
  if(currentUser && currentUser.role==='special'){
    const assigns=getAssignments(currentUser);
    return assigns.some(a=> a.mall===d.mall && a.section===d.section);
  }
  if(currentUser && currentUser.name==='مصطفى'){
    return !d.cancelled;
  }
  return true;
}

/* ======= Render Cards ======= */
function renderCards(){
  debts=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const fm=filterMall.value, fs=filterSection.value, fsp=filterSupplier.value, fst=filterStatus.value, fmo=filterMonth.value, fdisc=filterHasDiscount.checked;
  cardsGrid.innerHTML='';
  debts.forEach((d, idx)=>{
    if(!isVisibleForUser(d)) return;
    if(fm && d.mall!==fm) return;
    if(fs && d.section!==fs) return;
    if(fsp && d.supplier!==fsp) return;
    if(fst){
      if(fst==='approval_pending' && d.approval!=='pending') return;
      else if(fst==='approved' && d.approval!=='approved') return;
      else if(fst==='cancelled' && !d.cancelled) return;
      else if(['pending','late','paid'].includes(fst) && d.status!==fst) return;
    }
    if(fmo){ const ym=(d.created||d.due||'').slice(0,7); if(ym!==fmo) return; }
    if(fdisc && !((Number(d.discount)||0)>0)) return;

    if(searchQuery){
      const hay=(d.supplier+' '+d.mall+' '+d.section).toLowerCase();
      if(!hay.includes(searchQuery)) return;
    }

    const card = renderSingleCard(d, idx);
    cardsGrid.appendChild(card);
  });
}

function renderSingleCard(d, idx){
  const color=mallColor(d.mall);
  const st=calcStatus(d), appr=approvalInfo(d);
  const el=document.createElement('div'); el.className='card';
  const supplierDebtLine = (d.supplierDebt!=null && d.supplierDebt!=='') ? `<div class="value-line yellow-text" style="background:${color}">رصيد مديونية المورد: ${fmtNum(d.supplierDebt)} ريال</div>` : '';
  const priorityText = d.supplierPriority||'';
  const priorityLine = priorityText ? `<div class="value-line ${priorityText.includes('مرتفعة')?'yellow-text':'white-text'}" style="background:${color}">الأولوية: ${escapeHtml(priorityText)}</div>` : '';
  el.innerHTML=`
    <div class="mall-bar" style="background:${color}"></div>
    <div class="card-body">
      <div class="value-line" style="background:${color}">المورد: ${escapeHtml(d.supplier||'-')}</div>
      <div class="value-line" style="background:${color}">المركز: ${escapeHtml(d.mall||'-')}</div>
      <div class="value-line" style="background:${color}">القسم: ${escapeHtml(d.section||'-')}</div>
      ${supplierDebtLine}
      ${priorityLine}
      <div class="value-line" style="background:${color}">نوع التحويل: ${escapeHtml(d.transferKind||'-')}</div>
      <div class="value-line" style="background:${color}">المبلغ: ${fmtNum(d.amount)} — خصم: ${fmtNum(d.discount||0)}</div>
      <div class="value-line" style="background:${color}">الاستحقاق: ${escapeHtml(d.due||'-')}</div>
    </div>
    <div class="card-footer">
      ${appr.text? `<span class="status ${appr.cls}">${appr.text}</span>`:''}
      <span class="status ${st.cls}">${st.text}</span>
    </div>
    <div class="mall-bar bottom" style="background:${color}"></div>
  `;

  if(currentUser && (currentUser.role==='admin' || currentUser.name==='نصر')){
    const kb=document.createElement('button'); kb.className='kebab'; kb.innerHTML='<i class="fa fa-ellipsis-vertical"></i>';
    const menu=document.createElement('div'); menu.className='menu';

    const approveBtn=document.createElement('button');
    approveBtn.textContent='اعتماد الحوالة (يخصم من المخصص)';
    approveBtn.onclick=()=> approveDebt(idx);

    const unapproveBtn=document.createElement('button');
    unapproveBtn.textContent='إلغاء الاعتماد (يرجع للمخصص)';
    unapproveBtn.onclick=()=> unapproveDebt(idx);

    const cancelBtn=document.createElement('button');
    cancelBtn.textContent=d.cancelled?'إلغاء حالة الإلغاء':'إلغاء الحوالة';
    cancelBtn.onclick=()=>{ debts[idx].cancelled=!debts[idx].cancelled; saveDebts(); renderCards(); };

    menu.appendChild(approveBtn); menu.appendChild(unapproveBtn); menu.appendChild(cancelBtn);
    kb.addEventListener('click', (e)=>{ e.stopPropagation(); document.querySelectorAll('.menu.open').forEach(x=>x.classList.remove('open')); menu.classList.toggle('open'); });
    document.addEventListener('click', ()=> menu.classList.remove('open'));
    el.appendChild(kb); el.appendChild(menu);
  }

  if(currentUser && currentUser.canPay && d.approval==='approved' && d.status!=='paid' && !d.cancelled){
    const pay=document.createElement('button'); pay.className='top-btn action'; pay.style.padding='8px 12px'; pay.innerHTML='<i class="fa fa-money-bill-wave"></i> سداد';
    pay.onclick=()=> payDebt(idx);
    el.querySelector('.card-footer').appendChild(pay);
  }

  return el;
}

/* ======= Approve / Unapprove ======= */
function approveDebt(idx){
  const d=debts[idx];
  if(d.approval==='approved'){ alert('هذه الحوالة معتمدة مسبقًا.'); return; }
  const ym=(d.created||d.due||new Date().toISOString()).slice(0,7);
  const creator=d.createdBy; const mergedUsers={...BASE_USERS,...loadDynamicUsers()};
  const isSpecial = creator && mergedUsers[creator] && mergedUsers[creator].role==='special';
  const nett = netValue(d);
  if(isSpecial){
    const b=getBudget(ym, d.mall, d.section);
    if(!b || !b.approved || b.remaining < nett){
      alert('عذرا لا يوجد لديكم مخصص مالي بعد اما بسبب استنفاذ الرصيد أو لعدم اعتماد المخصصات بعد');
      return;
    }
    addConsumption(ym, d.mall, d.section, nett);
  }
  d.approval='approved';
  saveDebts();
  // نافذة إدخال رصيد المديونية + الأولوية
  approveExtrasIndex=idx;
  apSupplierDebt.value=''; apPriority.value='';
  show(modalApproveExtras,true);
  renderCards();
}
function unapproveDebt(idx){
  const d=debts[idx];
  if(d.approval!=='approved'){ alert('الحوالة ليست معتمدة.'); return; }
  const ym=(d.created||d.due||new Date().toISOString()).slice(0,7);
  const creator=d.createdBy; const mergedUsers={...BASE_USERS,...loadDynamicUsers()};
  const isSpecial = creator && mergedUsers[creator] && mergedUsers[creator].role==='special';
  const nett = netValue(d);
  if(isSpecial){ refundConsumption(ym, d.mall, d.section, nett); }
  d.approval='pending';
  saveDebts();
  renderCards();
}

/* ======= Pay (مختصر) ======= */
function payDebt(idx){
  const amt = prompt('أدخل المبلغ المسدّد:');
  if(!amt) return;
  const v=parseFloat(amt); if(!(v>0)) { alert('مبلغ غير صحيح'); return; }
  debts[idx].paidAmount=(debts[idx].paidAmount||0)+v;
  const net=netValue(debts[idx]);
  debts[idx].status = (debts[idx].paidAmount>=net)? 'paid' : 'pending';
  saveDebts(); renderCards();
}

/* ======= Modal Approve Extras ======= */
apSave.addEventListener('click', ()=>{
  if(approveExtrasIndex==null) { show(modalApproveExtras,false); return; }
  debts[approveExtrasIndex].supplierDebt = apSupplierDebt.value ? Number(apSupplierDebt.value)||0 : '';
  const pr=apPriority.value || '';
  debts[approveExtrasIndex].supplierPriority = pr ? (pr.includes('مرتفعة')?'أولوية مرتفعة':'أولوية عادية') : '';
  saveDebts();
  show(modalApproveExtras,false);
  renderCards();
});
apCancel.addEventListener('click', ()=> show(modalApproveExtras,false));

/* ======= Add Modal ======= */
function openAddModal(){
  if(!currentUser) {alert('سجل الدخول أولاً'); return;}
  if(!currentUser.canAdd) {alert('ليس لديك صلاحية لإضافة مديونيات'); return;}
  // mall/section lists depend on role
  fillAddMallAndSectionsByRole();
  fillAddSuppliers();
  updateAddBudgetNote();
  addAmount.value=''; addDiscount.value=''; addDue.value='';
  show(modalAdd,true);
}
addCancel.addEventListener('click', ()=> show(modalAdd,false));
addSave.addEventListener('click', ()=>{
  const mall=addMall.value, section=addSection.value, supplier=(addSupplier.value||'').trim();
  const transferKind=addTransferKind.value;
  const amount=parseFloat(addAmount.value); const discount=parseFloat(addDiscount.value)||0;
  const due=addDue.value;
  if(!supplier || !mall || !section || !amount || !due) { alert('اكمل الحقول المطلوبة'); return; }
  // التحقق من المخصص لمشرف القسم
  if(currentUser.role==='special'){
    const ym=currentMonthKey();
    const b=getBudget(ym, mall, section);
    const nett= Math.max(amount - discount, 0);
    if(!b || !b.approved || b.remaining < nett){
      alert('عذرا لا يوجد لديكم مخصص مالي بعد اما بسبب استنفاذ الرصيد أو لعدم اعتماد المخصصات بعد');
      return;
    }
  }
  const approval = (currentUser.role==='special') ? 'pending' : 'approved';
  const entry={mall, section, supplier, transferKind, amount, discount, due, status:'pending', paidAmount:0, paymentType:'', paidDate:'', approval, cancelled:false, createdBy: currentUser.name, created:new Date().toISOString(), supplierDebt:'', supplierPriority:''};
  debts.unshift(entry); saveDebts(); show(modalAdd,false); renderCards();
});

function fillAddMallAndSectionsByRole(){
  addMall.innerHTML=''; addSection.innerHTML='';
  if(currentUser.role==='special'){
    const assigns=getAssignments(currentUser);
    const malls=[...new Set(assigns.map(a=>a.mall))];
    malls.forEach(m=> addMall.appendChild(new Option(m,m)));
    const firstMall=addMall.value||malls[0];
    addSection.innerHTML='';
    assigns.filter(a=>a.mall===firstMall).forEach(a=> addSection.appendChild(new Option(a.section,a.section)));
    addMall.onchange=()=>{
      addSection.innerHTML='';
      const ms=getAssignments(currentUser).filter(a=>a.mall===addMall.value);
      ms.forEach(a=> addSection.appendChild(new Option(a.section,a.section)));
      fillAddSuppliers(); updateAddBudgetNote();
    };
    addSection.onchange=()=>{ fillAddSuppliers(); updateAddBudgetNote(); };
  } else {
    // أدوار أخرى: كل المولات وكل أقسام المول المختار
    Object.keys(MALL_SECTIONS).forEach(m=> addMall.appendChild(new Option(m,m)));
    const fillSecs=()=>{ addSection.innerHTML=''; (MALL_SECTIONS[addMall.value]||[]).forEach(s=> addSection.appendChild(new Option(s,s))); fillAddSuppliers(); updateAddBudgetNote(); };
    addMall.onchange=fillSecs; addSection.onchange=()=>{ fillAddSuppliers(); updateAddBudgetNote(); };
    fillSecs();
  }
}
function fillAddSuppliers(){
  const mall=addMall.value, sec=addSection.value;
  addSupplier.innerHTML=''; 
  const arr=(((SUPPLIERS[mall]||{})[sec])||[]);
  if(!arr.length) addSupplier.appendChild(new Option('لا يوجد موردون في هذا القسم',''));
  arr.forEach(s=> addSupplier.appendChild(new Option(s,s)));
}
function updateAddBudgetNote(){
  const ym=currentMonthKey(); const mall=addMall.value; const sec=addSection.value;
  const b=getBudget(ym,mall,sec);
  if(!b) { addBudgetNote.textContent='لا يوجد مخصص مسجل لهذا القسم حتى الآن.'; return;}
  addBudgetNote.textContent=`مخصص ${sec} في ${mall} لشهر ${monthLabel(ym)}: ${fmtNum(b.amount)} ريال — متبقٍ: ${fmtNum(b.remaining)} — ${b.approved?'(معتمد)':'(غير معتمد)'}`;
}

/* ======= Budget Modal ======= */
function openBudgetModal(){
  if(!(currentUser && (currentUser.name==='نصر' || currentUser.name==='مصطفى'))) { alert('مسموح لنصر ومصطفى فقط'); return; }
  budMall.innerHTML=''; Object.keys(MALL_SECTIONS).forEach(m=> budMall.appendChild(new Option(m,m)));
  budMonth.innerHTML=''; const base=new Date(); base.setMonth(base.getMonth()-1);
  for(let i=0;i<12;i++){const d=new Date(base.getFullYear(), base.getMonth()+i, 1); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'); const key=`${y}-${m}`; const opt=new Option(monthLabel(key), key); if(key===currentMonthKey()) opt.selected=true; budMonth.appendChild(opt); }
  budSecGrid.innerHTML='';
  show(modalBudget,true);
}
budClose.addEventListener('click', ()=> show(modalBudget,false));

budLoad.addEventListener('click', ()=> loadBudgetGrid(false));
budCopyPrev.addEventListener('click', ()=> loadBudgetGrid(true));
budFillBulk.addEventListener('click', ()=>{
  const v=prompt('أدخل قيمة تعبئة جماعية (ستطبق على كل الأقسام الظاهرة):'); if(!v) return;
  const n=parseFloat(v)||0;
  budSecGrid.querySelectorAll('input[type="number"][data-sec]').forEach(i=> i.value=n);
});

function loadBudgetGrid(copyPrev){
  const mall=budMall.value; const ym=budMonth.value;
  if(!mall||!ym){alert('اختر المركز والشهر'); return;}
  budSecGrid.innerHTML='';
  const prevKey = prevMonthKey(ym);
  (MALL_SECTIONS[mall]||[]).forEach(sec=>{
    const cur=getBudget(ym,mall,sec)||{amount:0,consumed:0,approved:false,remaining:0};
    let amt=cur.amount, appr=cur.approved;
    if(copyPrev){
      const prev=getBudget(prevKey,mall,sec);
      if(prev){ amt=prev.amount; appr=prev.approved; }
    }
    const card=document.createElement('div'); card.className='sec-card';
    card.innerHTML=`
      <div class="sec-title">${escapeHtml(sec)}</div>
      <div class="row">
        <input type="number" class="input" data-sec="${sec}" placeholder="المخصص (ريال)" value="${amt||0}">
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" class="bud-approve" data-sec="${sec}" ${appr?'checked':''}> اعتماد</label>
      </div>
      <div class="sec-foot"><span>مستهلك: ${fmtNum(cur.consumed||0)}</span><span>متبقٍ: ${fmtNum((cur.amount||0)-(cur.consumed||0))}</span></div>
    `;
    budSecGrid.appendChild(card);
  });
}
function prevMonthKey(ym){
  const [y,m]=ym.split('-').map(Number);
  const d=new Date(y, m-2, 1); // الشهر السابق
  const yy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'); return `${yy}-${mm}`;
}
budSave.addEventListener('click', ()=>{
  const mall=budMall.value; const ym=budMonth.value;
  if(!mall || !ym){ alert('اختر المركز والشهر'); return; }
  budSecGrid.querySelectorAll('input.input[data-sec]').forEach(inp=>{
    const sec=inp.getAttribute('data-sec');
    const amount = parseFloat(inp.value)||0;
    const approved = budSecGrid.querySelector(`.bud-approve[data-sec="${sec}"]`)?.checked || false;
    setBudget(ym, mall, sec, amount, approved);
  });
  alert('تم حفظ المخصصات');
  show(modalBudget,false);
});

/* ======= Admin Modal ======= */
function openAdminModal(){
  if(!currentUser || !(currentUser.role==='admin' || currentUser.name==='نصر')) {alert('غير مسموح'); return;}
  // تعبئة مكرّر التعيين للمشرف
  assignMall.innerHTML=''; Object.keys(MALL_SECTIONS).forEach(m=> assignMall.appendChild(new Option(m,m)));
  fillAssignSections();
  // موردين
  adminSupMall.innerHTML=''; Object.keys(MALL_SECTIONS).forEach(m=> adminSupMall.appendChild(new Option(m,m)));
  fillAdminSupSections();
  // إعدادات
  adminUserName.value=''; adminUserPass.value='';
  adminUserRole.value='admin'; specialAssignWrap.style.display='none';
  tempAssignments=[];
  renderAssignTags();
  renderAdminUsersList();
  show(modalAdmin,true);
}
adminClose.addEventListener('click', ()=> show(modalAdmin,false));

adminUserRole.addEventListener('change', ()=>{
  specialAssignWrap.style.display = (adminUserRole.value==='special') ? 'block' : 'none';
});

assignMall.addEventListener('change', fillAssignSections);
function fillAssignSections(){
  assignSection.innerHTML='';
  (MALL_SECTIONS[assignMall.value]||[]).forEach(s=> assignSection.appendChild(new Option(s,s)));
}

/* تجميع تعيينات مؤقت قبل الحفظ */
let tempAssignments=[];
assignAdd.addEventListener('click', ()=>{
  const mall=assignMall.value; const sec=assignSection.value;
  if(!mall||!sec) return;
  if(tempAssignments.some(a=> a.mall===mall && a.section===sec)) return;
  tempAssignments.push({mall,section:sec});
  renderAssignTags();
});
function renderAssignTags(){
  assignTags.innerHTML='';
  if(!tempAssignments.length){ assignTags.innerHTML='<div class="small-note">لا توجد تعيينات بعد.</div>'; return;}
  tempAssignments.forEach((a,i)=>{
    const t=document.createElement('span'); t.className='tag';
    t.innerHTML=`${escapeHtml(a.mall)} — ${escapeHtml(a.section)} <button title="إزالة" data-i="${i}"><i class="fa fa-times"></i></button>`;
    t.querySelector('button').onclick=()=>{ tempAssignments.splice(i,1); renderAssignTags(); };
    assignTags.appendChild(t);
  });
}

adminAddUser.addEventListener('click', ()=>{
  const name=adminUserName.value.trim(); const pass=adminUserPass.value.trim();
  const role=adminUserRole.value;
  if(!name||!pass){alert('أدخل اسم المستخدم وكلمة المرور'); return;}
  const dyn=loadDynamicUsers(); const all={...BASE_USERS,...dyn};
  if(all[name]){alert('اسم المستخدم موجود مسبقاً'); return;}
  let canAdd = (role==='admin' || role==='special');
  let canPay = (role==='admin' || role==='accountant');
  const user={pass,role,canAdd,canPay,isEnabled:true};
  if(role==='special'){
    if(!tempAssignments.length){alert('أضف تعيينًا واحدًا على الأقل للمشرف'); return;}
    user.assignments=tempAssignments.slice();
  }
  dyn[name]=user;
  saveDynamicUsers(dyn); USERS={...BASE_USERS,...dyn};
  alert('تم حفظ المستخدم');
  // تصفير
  adminUserName.value=''; adminUserPass.value='';
  tempAssignments=[]; renderAssignTags();
  renderAdminUsersList();
});

/* إضافة موردين */
adminSupMall.addEventListener('change', fillAdminSupSections);
function fillAdminSupSections(){
  const m=adminSupMall.value; adminSupSection.innerHTML='';
  (MALL_SECTIONS[m]||[]).forEach(s=> adminSupSection.appendChild(new Option(s,s)));
}
adminAddSuppliers.addEventListener('click', ()=>{
  const mall=adminSupMall.value; const section=adminSupSection.value; const text=adminSuppliersText.value.trim();
  if(!mall || !section || !text){ alert('أدخل المركز والقسم والمورد/الموردين'); return; }
  const names=text.split('\n').map(s=>s.trim()).filter(Boolean);
  if(!names.length){alert('لا توجد أسماء صالحة'); return;}
  const all=loadSuppliers(); if(!all[mall]) all[mall]={}; if(!all[mall][section]) all[mall][section]=[];
  const set=new Set(all[mall][section]); names.forEach(n=> set.add(n));
  all[mall][section]=Array.from(set);
  saveSuppliers(all); SUPPLIERS=all;
  alert('تمت الإضافة'); adminSuppliersText.value='';
});

/* قائمة المستخدمين — تجميد/حذف */
function renderAdminUsersList(){
  const dyn=loadDynamicUsers(); const entries=Object.entries(dyn);
  const wrap=adminUsersList; wrap.innerHTML='';
  if(!entries.length){ wrap.innerHTML='<div class="small-note">لا يوجد مستخدمون مضافون بعد.</div>'; return; }
  entries.forEach(([name,obj])=>{
    const el=document.createElement('div'); el.className='admin-item';
    const assigns = Array.isArray(obj.assignments) ? obj.assignments.map(a=>`${a.mall}—${a.section}`).join(' | ') : '';
    el.innerHTML=`
      <div>
        <strong>${escapeHtml(name)}</strong> — الدور: ${escapeHtml(translateRole(obj.role))}
        ${assigns? `<div class="small-note">التعيينات: ${escapeHtml(assigns)}</div>`:''}
        <div class="small-note">الحالة: ${obj.isEnabled===false? 'مجمّد' : 'نشط'}</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="top-btn" data-act="toggle">${obj.isEnabled===false? 'إلغاء التجميد' : 'تجميد'}</button>
        <button class="top-btn" data-act="del"><i class="fa fa-trash"></i></button>
      </div>
    `;
    const [toggle, del] = el.querySelectorAll('button');
    toggle.onclick=()=>{
      const d=loadDynamicUsers(); if(!d[name]) return;
      d[name].isEnabled = (d[name].isEnabled===false) ? true : false;
      saveDynamicUsers(d); USERS={...BASE_USERS,...d}; renderAdminUsersList();
    };
    del.onclick=()=>{
      if(confirm('حذف المستخدم؟')){
        const d=loadDynamicUsers(); delete d[name]; saveDynamicUsers(d); USERS={...BASE_USERS,...d}; renderAdminUsersList();
      }
    };
    wrap.appendChild(el);
  });
}

/* ======= Utils ======= */
function show(el, on){ el.style.display = on? 'flex':'none'; }

/* ======= init ======= */
(function init(){
  USERS={...BASE_USERS,...loadDynamicUsers()};
  // استرجاع جلسة
  const ses=localStorage.getItem(SESSION_KEY);
  if(ses && USERS[ses] && USERS[ses].isEnabled!==false){
    currentUser={name:ses, ...USERS[ses]};
    loginScreen.style.display='none'; appEl.style.display='block';
    welcomeTitle.textContent=`مرحباً، ${ses}`; roleLabel.textContent=`الدور: ${translateRole(USERS[ses].role)}`;
    applyRoleFeatures();
  }
  populateFilterSections();
  populateSupplierFilter();
  renderCards();
})();
</script>
</body>
</html>
