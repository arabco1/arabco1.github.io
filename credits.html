
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>شاشة إدارة المديونيات — نهائي (محدث)</title>
<link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --primary:#0b3a8a;
  --accent:#ffd83a;
  --bg-grad: linear-gradient(135deg,#071735 0%, #0b2b6f 100%);
  --glass: rgba(255,255,255,0.08);
  --card-w: 320px;
  --card-h: 400px;
  --radius: 18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Almarai',sans-serif;background:var(--bg-grad);color:#fff;-webkit-font-smoothing:antialiased;min-height:100vh;padding:18px}
/* login */
#loginScreen{display:flex;align-items:center;justify-content:center;height:calc(100vh - 36px);padding:20px}
.login-card{width:380px;padding:32px;border-radius:16px;background:var(--glass);backdrop-filter:blur(8px);box-shadow:0 10px 40px rgba(2,6,23,0.6);text-align:center}
.login-card h1{margin:0 0 12px;font-size:22px}
.input{width:100%;padding:12px 14px;margin:9px 0;border-radius:12px;border:none;font-size:15px;text-align:center;background:rgba(255,255,255,0.06);color:#fff}
.btn{width:100%;padding:12px;border-radius:12px;border:none;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--accent),#f0c032);color:#000;margin-top:12px;box-shadow:0 8px 24px rgba(0,0,0,0.25)}
/* app */
#app{display:none;padding:18px;max-width:1400px;margin:8px auto}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
.brand{display:flex;align-items:center;gap:14px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#00204a);display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,0.35)}
.brand h2{margin:0;font-size:18px}
.controls{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.top-btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:transparent;color:#fff}
.top-btn.primary{background:rgba(255,255,255,0.06);box-shadow:inset 0 -2px 0 rgba(0,0,0,0.08)}
.top-btn.action{background:linear-gradient(90deg,var(--accent),#f0c032);color:#000}
.search-wrap{display:flex;align-items:center;gap:8px}
.search-input{width:220px;padding:8px;border-radius:10px;border:none;background:rgba(255,255,255,0.06);color:#fff;display:none}
/* filters */
.filters{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
.select{background:var(--glass);padding:10px;border-radius:12px;border:none;color:#fff;min-width:160px;text-align:center}
.grid{display:grid;grid-template-columns:repeat(4,minmax(var(--card-w),1fr));gap:20px;justify-items:center;align-items:start;padding-bottom:20px}
.card{width:var(--card-w);height:var(--card-h);background:linear-gradient(180deg,rgba(255,255,255,0.98),#fff);border-radius:var(--radius);color:#000;box-shadow:0 12px 30px rgba(2,6,23,0.18);overflow:hidden;display:flex;flex-direction:column;justify-content:space-between;padding:14px;transform:translateZ(0);transition:transform .22s, box-shadow .22s}
.card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.22)}
.card h3{margin:0;font-size:16px;text-align:center}
.info{background:var(--accent);border-radius:10px;padding:8px 10px;text-align:center;font-weight:700;color:#000;margin:6px 0}
.status{display:inline-block;padding:8px 12px;border-radius:12px;font-weight:800}
.status.pending{background:#ffd83a;color:#000}
.status.late{background:#e53935;color:#fff}
.status.paid{background:#2ecc71;color:#fff}
.card-footer{display:flex;gap:8px;justify-content:center;align-items:center}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:60}
.modal{width:620px;background:var(--glass);padding:18px;border-radius:14px;backdrop-filter:blur(8px);box-shadow:0 18px 60px rgba(0,0,0,0.45)}
.modal h3{margin:0 0 10px;color:#fff}
.modal .row{display:flex;gap:10px;margin:8px 0}
.modal input,.modal select{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.06);color:#fff}
.dashboard{margin-top:10px;background:var(--glass);padding:16px;border-radius:14px;backdrop-filter:blur(8px)}
.stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.stat{background:linear-gradient(90deg,#ffffff,#fff);padding:12px;border-radius:12px;min-width:160px;text-align:center;color:#000;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,0.12)}
.canvas-wrap{background:#fff;border-radius:12px;padding:12px}
.small-note{font-size:13px;color:rgba(0,0,0,0.6);margin-top:8px}
@media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(220px,1fr))}}
@media(max-width:720px){.login-card{width:92%}.modal{width:92%}.card{width:92%}.grid{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-card">
    <h1>شاشة ادارة المديونيات</h1>
    <p class="small-muted">سجل الدخول</p>
    <input id="inputUser" class="input" placeholder="اسم المستخدم">
    <input id="inputPass" type="password" class="input" placeholder="كلمة المرور">
    <button class="btn" id="btnLogin">دخول</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="topbar">
    <div class="brand">
      <div class="logo">ن</div>
      <div>
        <h2 id="welcomeTitle">مرحبا</h2>
        <div class="small-muted" id="roleLabel">دور المستخدم</div>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:10px">
      <div class="search-wrap">
        <input id="searchInput" class="search-input" placeholder="ابحث عن مورد أو موقع...">
        <button class="top-btn" id="btnSearchToggle" title="بحث"><i class="fa fa-search"></i></button>
      </div>
      <div class="controls" style="margin-left:auto">
        <button class="top-btn primary" id="btnShowCards" title="كروت المديونيات"><i class="fa fa-th-large"></i> كروت المديونيات</button>
        <button class="top-btn action" id="btnShowAdd" title="ترحيل مديونية"><i class="fa fa-plus-circle"></i> ترحيل طلب جديد</button>
        <button class="top-btn" id="btnShowDash" title="لوحة البيانات"><i class="fa fa-chart-bar"></i> لوحة البيانات</button>
        <button class="top-btn" id="btnLogout" title="تسجيل الخروج"><i class="fa fa-sign-out-alt"></i> خروج</button>
      </div>
    </div>
  </div>

  <!-- filters -->
  <div class="filters" style="margin-bottom:12px">
    <select id="filterMall" class="select">
      <option value="">كل المولات</option>
      <option>الانصار مول</option>
      <option>ابيات عسير</option>
      <option>فور بارك</option>
      <option>العرب بلازا</option>
    </select>
    <select id="filterSection" class="select">
      <option value="">كل الأقسام</option>
      <option>المفروشات</option>
      <option>المنزلية</option>
      <option>العطور</option>
    </select>
    <select id="filterSupplier" class="select">
      <option value="">كل الموردين</option>
    </select>
    <select id="filterStatus" class="select">
      <option value="">كل الحالات</option>
      <option value="pending">مستحقة</option>
      <option value="late">متأخر</option>
      <option value="paid">مسدد</option>
    </select>
    <input id="filterMonth" type="month" class="select" style="min-width:170px" />
  </div>

  <!-- grid of cards -->
  <div class="grid" id="cardsGrid"></div>

  <!-- dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="stats">
      <div class="stat" id="statTotal">الاجمالي: 0</div>
      <div class="stat" id="statPaid">مسدد: 0</div>
      <div class="stat" id="statPending">معلق: 0</div>
      <div class="stat" id="statCount">عدد المديونيات: 0</div>
    </div>
    <div class="canvas-wrap"><canvas id="chartDept" height="160"></canvas></div>
  </div>
</div>

<!-- Add modal -->
<div class="modal-backdrop" id="modalAddBackdrop">
  <div class="modal">
    <h3>إضافة مديونية جديدة</h3>
    <div class="row">
      <select id="addSection" class="select">
        <option value="المفروشات">المفروشات</option>
        <option value="المنزلية">المنزلية</option>
        <option value="العطور">العطور</option>
      </select>
      <select id="addSupplier" class="select"><option>اختر المورد</option></select>
    </div>
    <div class="row">
      <select id="addMall" class="select">
        <option value="الانصار مول">الانصار مول</option>
        <option value="ابيات عسير">ابيات عسير</option>
        <option value="فور بارك">فور بارك</option>
        <option value="العرب بلازا">العرب بلازا</option>
      </select>
      <input id="addAmount" type="number" placeholder="مبلغ التحويل (يدوي)">
    </div>
    <div class="row">
      <input id="addDiscount" type="number" placeholder="مبلغ الخصم (يدوي)">
      <input id="addDue" type="date">
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="addSave">حفظ</button>
      <button class="btn" id="addCancel" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.12)">إلغاء</button>
    </div>
  </div>
</div>

<!-- Pay modal -->
<div class="modal-backdrop" id="modalPayBackdrop">
  <div class="modal">
    <h3 id="payTitle">تأكيد السداد</h3>
    <div class="row">
      <input id="payAmount" type="number" placeholder="المبلغ الفعلي">
      <input id="payPass" type="password" placeholder="كلمة المرور">
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="payConfirm">تأكيد</button>
      <button class="btn" id="payCancel" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.12)">إلغاء</button>
    </div>
    <p class="small-note">المستخدم يجب أن يدخل كلمة المرور الخاصة به لتأكيد السداد.</p>
  </div>
</div>

<script>
/* Users */
const USERS = {
  "نصر": { pass: "71111", role: "admin", canAdd: true, canPay: true, allowedSection: null },
  "مصطفى": { pass: "123456", role: "collector", canAdd: false, canPay: true, allowedSection: null },
  "استعلام": { pass: "123456", role: "viewer", canAdd: false, canPay: false, allowedSection: null },
  "جياب": { pass: "71111", role: "special", canAdd: true, canPay: false, allowedSection: "المنزلية" },
  "راجح": { pass: "73333", role: "special", canAdd: true, canPay: false, allowedSection: "المفروشات" },
  "العطور": { pass: "81111", role: "special", canAdd: true, canPay: false, allowedSection: "العطور" }
};
/* Suppliers per section */
const SUPPLIERS = {
  "المفروشات": [
    'شركة زهرة بيسان للتجارة','شركة الجنادرية للمفروشات','شركة الهرم الدولي /مفروشات هرم المدينة','شموع الجزيرة','شركة نور التجارية للتحف والهدايا','قارة هوم/افاق هوم','مؤسسة عالم الجوهرة للتجارة','مؤسسة اثاث غاليري للتجارة','شركة نوادر التصاميم للتجارة','شركة روائع النسيج للاقمشة (مراتب المملكة)','شركة رواد العائلة','مؤسسة فراج محمد الجوير التجارية','شركة رونق المنزل للصناعة','مؤسسة جبل ثهلان للتجارة','قصر الكلاسيك','ورشة تلال نجد للحدادة والالمونيوم','شركة روائع القلعة للصناعة','مؤسسة الموهوب الصغير (روما ستار)','غرائب التحف','شركة بيت المراتب والمفروشات','مؤسسة تشكيلات الإبداع للحدادةــ ورشة نوف','شركة بانوب للتجارة','مؤسسة ركن المعرفة الاولي للتجارة','معرض التوفيق ــ عبدالله العبد اللطيف','مؤسسة عامر بامسق','مؤسسة نواف سليمان عيد الحبيشي','مطابع لمسة الوادي','مخازن الانارة(تحفتي ذوق)','شركة طيف البستان تحف وهدايا','شركة بيت الاثاث السعودي','مؤسسة هزاع عواض الهبداني للتجارة'
  ],
  "المنزلية": [
    'شركة السيف للتوكيلات التجارية/ الرياض','شركة رمز الجودة/عبدالرحمن قاسم سابقا','شركة ريفان الدولية منزلية','شركة سما للاواني المنزلية(العيسائي )','شركة السيف قسم الكهربائيات','شركة بن شيهون ابو عمر','شركة اواني مائدتي التجارية (الجهوري)','شركة مصنع بيت التصنيع البلاستيكي','مؤسسة التاج المنزلية للتجارة','اواني الاسطورة','جيباس','شركة بن شيهون ترامس روز','شركة المجموعة المنزلية للتجارة','شركة المهيدب اول مهمة المحدودة','شركة ريبون العالمية (منزلية)','مؤسسة المطري للاواني المنزلية','شركة بيتك الذهبي للتجارة','شركة الماسة للاواني الفاخرة','مؤسسة الاصايل للتجارة','الصبيحي منزلية','شركة - الدالة العربية','شركة الاعتصام الخليجي','مؤسسة سواة الخليج','مصنع اعمال الريادة(السعودي للمكانس سابقا)'
  ],
  "العطور": [
    'مؤسسة دار سمائل','النرجس للعطور','مؤسسة المستثمر الرائد للتجارة','شركة صفوة العطور للتجارة','مؤسسة اجمل الخليجية للتجميل','شركة امواج التجميل المحدودة','شركة وجه الجمال للتجارة','الاسطورة للاكسسوارات','مؤسسة عالم الامل للاكسسوارات','شركة ريبون العالمية (تجميل)','شركة قمة الاسطورة المحدودة','شركة عوارض للتجارة','شركة الزمان التجارية (اجمل)'
  ]
};

/* Data storage */
const LS_KEY = 'pos_debts_final_v2';
let debts = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
function saveDebts(){ localStorage.setItem(LS_KEY, JSON.stringify(debts)); }

// seed
if(!debts.length){
  debts = [
    { location:'الجنادرية', mall:'الانصار مول', section:'المفروشات', supplier: SUPPLIERS['المفروشات'][0], amount:5000, discount:0, due:'2025-09-20', status:'pending', paidAmount:0, created:new Date().toISOString() },
    { location:'حي النور', mall:'ابيات عسير', section:'المنزلية', supplier: SUPPLIERS['المنزلية'][0], amount:3200, discount:0, due:'2025-09-10', status:'late', paidAmount:0, created:new Date().toISOString() }
  ];
  saveDebts();
}

/* Helpers */
function fmtNum(n){ return Number(n||0).toLocaleString('en-US'); }
function calcStatus(d){ if(d.status==='paid') return {text:'مسدد',cls:'paid'}; const diff=(new Date()-new Date(d.due))/(1000*60*60*24); if(diff>7) return {text:'متأخر',cls:'late'}; return {text:'مستحق',cls:'pending'}; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* Elements */
const loginScreen = document.getElementById('loginScreen');
const appEl = document.getElementById('app');
const welcomeTitle = document.getElementById('welcomeTitle');
const roleLabel = document.getElementById('roleLabel');
const cardsGrid = document.getElementById('cardsGrid');
const modalAdd = document.getElementById('modalAddBackdrop');
const modalPay = document.getElementById('modalPayBackdrop');
const chartCtx = document.getElementById('chartDept').getContext('2d');
let deptChart = null;
let currentUser = null;
let searchQuery = '';

/* Login */
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const u = document.getElementById('inputUser').value.trim();
  const p = document.getElementById('inputPass').value.trim();
  if(!u||!p){ alert('أدخل اسم المستخدم وكلمة المرور'); return; }
  if(USERS[u] && USERS[u].pass === p){ currentUser = {name:u,...USERS[u]}; loginScreen.style.display='none'; appEl.style.display='block'; welcomeTitle.textContent = `مرحباً، ${u}`; roleLabel.textContent = `الصلاحية: ${USERS[u].role}`; applyRoleFeatures(); refreshAll(); startAutoLogout(); } else alert('اسم المستخدم أو كلمة المرور غير صحيح');
});

/* Top controls */
document.getElementById('btnLogout').addEventListener('click', ()=>{ if(confirm('هل تريد تسجيل الخروج؟')) doLogout(); });
document.getElementById('btnShowAdd').addEventListener('click', ()=> openAddModal());
document.getElementById('btnShowDash').addEventListener('click', ()=> document.getElementById('dashboard').scrollIntoView({behavior:'smooth'}));
document.getElementById('btnShowCards').addEventListener('click', ()=> cardsGrid.scrollIntoView({behavior:'smooth'}));

/* Search toggle */
document.getElementById('btnSearchToggle').addEventListener('click', ()=>{
  const si = document.getElementById('searchInput'); si.style.display = si.style.display === 'inline-block' ? 'none' : 'inline-block'; if(si.style.display==='inline-block') si.focus(); else { si.value=''; searchQuery=''; renderCards(); }
});
document.getElementById('searchInput').addEventListener('input', (e)=>{ searchQuery = e.target.value.trim().toLowerCase(); renderCards(); });

/* apply role */
function applyRoleFeatures(){
  document.getElementById('btnShowAdd').style.display = currentUser.canAdd ? 'inline-block' : 'none';
  // set section filter if special
  const fs = document.getElementById('filterSection'); if(currentUser.allowedSection){ fs.value = currentUser.allowedSection; fs.disabled = true; } else { fs.disabled = false; }
  populateSupplierFilter();
}

/* populate supplier filter based on section and user */
function populateSupplierFilter(){
  const filterSectionEl = document.getElementById('filterSection');
  const selSection = filterSectionEl.value;
  const el = document.getElementById('filterSupplier'); el.innerHTML='';
  const addEl = document.getElementById('addSupplier'); addEl.innerHTML='';

  if(currentUser && currentUser.name === 'نصر'){
    // admin: show grouped suppliers
    el.appendChild(new Option('كل الموردين',''));
    Object.keys(SUPPLIERS).forEach(section=>{
      const arr = SUPPLIERS[section];
      if(arr && arr.length){
        const optgroup = document.createElement('optgroup'); optgroup.label = section;
        arr.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; optgroup.appendChild(o); });
        el.appendChild(optgroup);
      }
    });
    // for add modal: let admin pick section first
    const addSection = document.getElementById('addSection'); addSection.disabled = false;
    populateAddSupplierBySection(addSection.value || 'المفروشات');
  } else if(currentUser && currentUser.allowedSection){
    const list = SUPPLIERS[currentUser.allowedSection] || [];
    el.appendChild(new Option('كل الموردين',''));
    list.forEach(s => el.appendChild(new Option(s,s)));
    // add modal
    document.getElementById('addSection').value = currentUser.allowedSection; document.getElementById('addSection').disabled = true;
    populateAddSupplierBySection(currentUser.allowedSection);
  } else {
    // guest/other: if a section is selected, show that section suppliers, else show all
    if(selSection){ const arr = SUPPLIERS[selSection] || []; el.appendChild(new Option('كل الموردين','')); arr.forEach(s=>el.appendChild(new Option(s,s))); populateAddSupplierBySection(selSection); }
    else { el.appendChild(new Option('كل الموردين','')); const all = new Set(); Object.values(SUPPLIERS).forEach(arr=>arr.forEach(s=>all.add(s))); Array.from(all).forEach(s=>el.appendChild(new Option(s,s))); populateAddSupplierBySection(document.getElementById('addSection').value); }
  }
}

document.getElementById('filterSection').addEventListener('change', ()=>{ populateSupplierFilter(); renderCards(); updateDashboard(); });

/* Add Supplier populate by section */
function populateAddSupplierBySection(section){ const el = document.getElementById('addSupplier'); el.innerHTML=''; const arr = SUPPLIERS[section] || []; arr.forEach(s=> el.appendChild(new Option(s,s))); }

document.getElementById('addSection').addEventListener('change', (e)=> populateAddSupplierBySection(e.target.value));

/* Render cards dynamic */
function renderCards(){ debts = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); const filterMall = document.getElementById('filterMall').value; const filterSection = document.getElementById('filterSection').value; const filterSupplier = document.getElementById('filterSupplier').value; const filterStatus = document.getElementById('filterStatus').value; const filterMonth = document.getElementById('filterMonth').value;

  cardsGrid.innerHTML='';
  debts.forEach((d, idx)=>{
    if(currentUser && currentUser.allowedSection && d.section !== currentUser.allowedSection) return;
    if(filterMall && d.mall !== filterMall) return;
    if(filterSection && d.section !== filterSection) return;
    if(filterSupplier && d.supplier !== filterSupplier) return;
    if(filterStatus && d.status !== filterStatus) return;
    if(filterMonth){ const ym = (d.created||d.due).slice(0,7); if(ym !== filterMonth) return; }
    if(searchQuery){ const hay = (d.supplier + ' ' + d.location + ' ' + d.mall).toLowerCase(); if(!hay.includes(searchQuery)) return; }

    const st = calcStatus(d);
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div>
        <h3>${escapeHtml(d.location || '-')}</h3>
        <div class="info">المول: ${escapeHtml(d.mall)}</div>
        <div class="info">القسم: ${escapeHtml(d.section)}</div>
        <div class="info">المورد: ${escapeHtml(d.supplier)}</div>
        <div class="info">المبلغ: ${fmtNum(d.amount)} ريال — خصم: ${fmtNum(d.discount||0)}</div>
        <div class="info">تاريخ الاستحقاق: ${d.due || '-'}</div>
      </div>
      <div class="card-footer">
        <span class="status ${st.cls}">${st.text}</span>
      </div>
    `;

    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.justifyContent='center'; actions.style.marginTop='8px';
    if(currentUser && currentUser.canPay && d.status !== 'paid'){
      const payBtn = document.createElement('button'); payBtn.className='top-btn action'; payBtn.style.padding='8px 12px'; payBtn.innerHTML = '<i class="fa fa-money-bill-wave"></i> سداد'; payBtn.onclick = ()=> openPayModal(idx);
      actions.appendChild(payBtn);
    }
    card.appendChild(actions);
    cardsGrid.appendChild(card);
  });
}

/* Add modal */
function openAddModal(){ if(!currentUser) return alert('سجل الدخول أولاً'); if(!currentUser.canAdd) return alert('ليس لديك صلاحية لإضافة مديونيات');
  // populate suppliers according to user or section
  if(currentUser.name === 'نصر'){ document.getElementById('addSection').disabled = false; populateAddSupplierBySection(document.getElementById('addSection').value); }
  else { document.getElementById('addSection').value = currentUser.allowedSection; document.getElementById('addSection').disabled = true; populateAddSupplierBySection(currentUser.allowedSection); }
  document.getElementById('addAmount').value=''; document.getElementById('addDiscount').value=''; document.getElementById('addDue').value=''; modalAdd.style.display='flex'; }

document.getElementById('addCancel').addEventListener('click', ()=> modalAdd.style.display='none');
document.getElementById('addSave').addEventListener('click', ()=>{
  const supplier = document.getElementById('addSupplier').value.trim(); const mall = document.getElementById('addMall').value.trim(); const section = document.getElementById('addSection').value.trim(); const amount = parseFloat(document.getElementById('addAmount').value); const discount = parseFloat(document.getElementById('addDiscount').value) || 0; const due = document.getElementById('addDue').value;
  if(!supplier || !mall || !section || !amount || !due) return alert('اكمل الحقول المطلوبة');
  if(currentUser.allowedSection && currentUser.allowedSection !== section) return alert('غير مسموح لك بإدخال مديونيات في هذا القسم');
  const entry = { location:'-', mall, section, supplier, amount, discount, due, status:'pending', paidAmount:0, created:new Date().toISOString() };
  debts.unshift(entry); saveDebts(); modalAdd.style.display='none'; renderCards(); updateDashboard();
});

/* Pay modal */
let payIndex = null; function openPayModal(idx){ payIndex = idx; const d = debts[idx]; document.getElementById('payAmount').value = (d.amount - (d.paidAmount||0)) || 0; document.getElementById('payPass').value=''; document.getElementById('payTitle').textContent = `سداد — ${d.supplier}`; modalPay.style.display='flex'; }
document.getElementById('payCancel').addEventListener('click', ()=> modalPay.style.display='none');
document.getElementById('payConfirm').addEventListener('click', ()=>{
  const amt = parseFloat(document.getElementById('payAmount').value); const pass = document.getElementById('payPass').value;
  if(!currentUser || !currentUser.canPay) return alert('غير مسموح لك بالسداد');
  if(USERS[currentUser.name].pass !== pass) return alert('كلمة المرور غير صحيحة');
  if(!amt || amt<=0) return alert('أدخل مبلغ صحيح');
  debts[payIndex].paidAmount = (debts[payIndex].paidAmount||0) + amt;
  const net = debts[payIndex].amount - (debts[payIndex].discount||0);
  if(debts[payIndex].paidAmount >= net) debts[payIndex].status = 'paid';
  saveDebts(); modalPay.style.display='none'; renderCards(); updateDashboard();
});

/* Dashboard */
function updateDashboard(){ debts = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); const userAllowed = currentUser && currentUser.allowedSection ? currentUser.allowedSection : null; let relevant = debts.slice(); if(userAllowed) relevant = relevant.filter(d=>d.section===userAllowed);
  const filterMall = document.getElementById('filterMall').value; const filterSupplier = document.getElementById('filterSupplier').value; const filterMonth = document.getElementById('filterMonth').value; const filterStatus = document.getElementById('filterStatus').value;
  if(filterMall) relevant = relevant.filter(d=>d.mall===filterMall);
  if(filterSupplier) relevant = relevant.filter(d=>d.supplier===filterSupplier);
  if(filterMonth) relevant = relevant.filter(d=> (d.created||d.due).slice(0,7)===filterMonth);
  if(filterStatus) relevant = relevant.filter(d=>d.status===filterStatus);
  const total = relevant.reduce((s,d)=> s + (d.amount||0),0); const paid = relevant.reduce((s,d)=> s + (d.paidAmount||0),0); const pending = total - paid; const count = relevant.length;
  document.getElementById('statTotal').textContent = `الاجمالي: ${fmtNum(total)}`; document.getElementById('statPaid').textContent = `مسدد: ${fmtNum(paid)}`; document.getElementById('statPending').textContent = `معلق: ${fmtNum(pending)}`; document.getElementById('statCount').textContent = `عدد المديونيات: ${count}`;
  // chart by supplier (top 12)
  const map = {}; relevant.forEach(d=>{ if(!map[d.supplier]) map[d.supplier] = {planned:0, paid:0, late:0}; map[d.supplier].planned += d.amount||0; map[d.supplier].paid += d.paidAmount||0; if(calcStatus(d).cls==='late') map[d.supplier].late += d.amount||0; });
  const labels = Object.keys(map).sort((a,b)=>map[b].planned-map[a].planned).slice(0,12); const planned = labels.map(l=>map[l].planned); const paidArr = labels.map(l=>map[l].paid); const lateArr = labels.map(l=>map[l].late);
  if(deptChart) deptChart.destroy(); deptChart = new Chart(chartCtx, { type:'bar', data:{ labels, datasets:[ {label:'المستحق', data:planned, backgroundColor:'#ffd83a'}, {label:'المسددة', data:paidArr, backgroundColor:'#4caf50'}, {label:'المتأخرة', data:lateArr, backgroundColor:'#e53935'} ] }, options:{ responsive:true, plugins:{legend:{labels:{color:'#000'}}}, scales:{x:{ticks:{color:'#000'}}, y:{ticks:{color:'#000'}}} } });
}

/* Filters listeners */
['filterMall','filterSupplier','filterMonth','filterStatus'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change', ()=>{ renderCards(); updateDashboard(); }); });

/* refresh / logout / auto-logout */
function refreshAll(){ populateSupplierFilter(); renderCards(); updateDashboard(); }
function doLogout(){ currentUser=null; document.getElementById('inputUser').value=''; document.getElementById('inputPass').value=''; appEl.style.display='none'; loginScreen.style.display='flex'; clearTimeout(logoutTimer); }
let logoutTimer = null; function startAutoLogout(){ if(logoutTimer) clearTimeout(logoutTimer); logoutTimer = setTimeout(()=>{ alert('انتهت الجلسة — تم تسجيل الخروج تلقائيًا'); doLogout(); }, 4*60*60*1000); }
['mousemove','keydown','click','touchstart'].forEach(ev => window.addEventListener(ev, startAutoLogout));

/* init */
(function init(){ populateSupplierFilter(); renderCards(); updateDashboard(); })();
</script>
</body>
</html>
