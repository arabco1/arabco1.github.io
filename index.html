<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>مؤشرات الأداء الشهرية — واجهة أنيقة</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg-1:#0b2b6f; --bg-2:#001542;
      --brand:#2b6aff; --brand-dark:#144dcb; --accent:#ffd83a;
      --text:#f6f8ff; --muted:#b9c7ff;
      --glass: rgba(255,255,255,.12); --stroke: rgba(255,255,255,.18);
      --radius:18px; --radius-lg:22px; --pad:18px; --gap:16px;
      --shadow:0 10px 40px rgba(0,0,0,.28);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Cairo',system-ui,Segoe UI,Arial,sans-serif;
      background:
        radial-gradient(1100px 520px at 80% -10%, #1a4bd6 0%, transparent 60%),
        radial-gradient(900px 460px at 10% 110%, #0a1f54 0%, transparent 60%),
        linear-gradient(90deg,var(--bg-1),var(--bg-2));
      color:var(--text);
      overflow-x:hidden;
    }

    /* خلفية متحركة */
    .bg-grid{
      position:fixed; inset:0; pointer-events:none; z-index:-3;
      background:
        linear-gradient(transparent 95%, rgba(255,255,255,.06) 95%),
        linear-gradient(90deg, transparent 95%, rgba(255,255,255,.06) 95%);
      background-size:60px 60px,60px 60px;
      opacity:.35; animation:grid-move 30s linear infinite;
    }
    @keyframes grid-move{
      0%{background-position:0 0,0 0}
      100%{background-position:600px 600px,600px 600px}
    }
    .orb{
      position:fixed; border-radius:50%; filter:blur(30px); opacity:.35; z-index:-2;
      background: radial-gradient(circle at 30% 30%, #2b6aff 0%, #001542 60%);
      animation: float 22s ease-in-out infinite;
    }
    .orb.o2{ width:320px;height:320px; top:10%; left:-6%; animation-duration:26s; background: radial-gradient(circle at 40% 40%, #ffd83a 0%, #0b2b6f 70%); }
    .orb.o1{ width:380px;height:380px; bottom:8%; right:-5%; }
    @keyframes float{
      0%{ transform:translate(0,0) scale(1)}
      50%{ transform:translate(30px,-20px) scale(1.06)}
      100%{ transform:translate(0,0) scale(1)}
    }

    .container{width:min(1180px,95vw);margin-inline:auto;padding:24px 16px 80px}

    /* ألواح زجاجية */
    .panel{
      background:var(--glass); border:1px solid var(--stroke);
      backdrop-filter: blur(14px) saturate(120%); -webkit-backdrop-filter: blur(14px) saturate(120%);
      border-radius:var(--radius-lg); box-shadow:var(--shadow);
    }

    /* رأس */
    .header.panel{padding:18px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-size:clamp(18px,2.6vw,26px);font-weight:800;color:#fff}
    .badges{display:flex;gap:10px;flex-wrap:wrap}
    .badge{background:rgba(255,255,255,.08);border:1px solid var(--stroke);padding:6px 10px;border-radius:10px;color:#fff;font-weight:800;font-size:clamp(12px,1.6vw,13px)}
    .accent{color:var(--accent)}

    /* شبكة المراكز (صفين) */
    .malls-grid{
      display:grid; gap:var(--gap);
      grid-template-columns:repeat(2,minmax(280px,1fr));
      align-items:stretch;
    }
    @media (max-width:820px){
      .malls-grid{grid-template-columns:1fr}
    }
    .grid-divider{
      grid-column:1 / -1; height:1px; margin:2px 4px 10px;
      background:linear-gradient(90deg,rgba(255,255,255,.0),rgba(255,255,255,.22),rgba(255,255,255,.0));
      border-radius:999px; opacity:.55;
      display:block;
    }

    .mall-card{
      position:relative; padding:18px; text-align:center; cursor:pointer; overflow:hidden;
      background:rgba(255,255,255,.10); border:1px solid var(--stroke); border-radius:18px; box-shadow:var(--shadow);
      transition:transform .18s ease, box-shadow .18s ease;
    }
    .mall-card::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
    .mall-card:active{transform:scale(.985)}
    .mall-icon{font-size:clamp(22px,3.5vw,32px);color:var(--accent);margin-bottom:.5rem}
    .mall-card h2{font-size:clamp(14px,2vw,16px);margin-bottom:.15rem;font-weight:800}
    .mall-card h1{font-size:clamp(20px,4.2vw,30px);line-height:1;color:#fff}
    .mall-percentage{font-variant-numeric:tabular-nums}
    .performance-status{font-size:clamp(12px,1.8vw,13px);margin-top:.35rem}
    .above-target{color:#c8ffb7}.below-target{color:#ffe29b}

    /* عناوين أقسام */
    .section-title{margin:22px 6px 12px;color:#dfe6ff;font-weight:800;letter-spacing:.3px;font-size:18px;display:flex;align-items:center;gap:8px}

    /* بطاقات المؤشرات الإضافية (مختصرة) */
    .extras-cards{
      display:grid; gap:16px;
      grid-template-columns:repeat(4,minmax(220px,1fr));
    }
    @media (max-width:1180px){ .extras-cards{grid-template-columns:repeat(3,minmax(220px,1fr))} }
    @media (max-width:900px){ .extras-cards{grid-template-columns:repeat(2,minmax(220px,1fr))} }
    @media (max-width:600px){ .extras-cards{grid-template-columns:1fr} }

    .stat-card{
      padding:14px; border-radius:16px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.10); box-shadow:var(--shadow); display:flex; gap:12px; align-items:center;
    }
    .stat-icon{
      width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:rgba(255,255,255,.08); border:1px solid var(--stroke); color:var(--accent); font-size:18px; flex-shrink:0;
    }
    .stat-info{display:flex;flex-direction:column;gap:2px;min-width:0}
    .stat-title{font-size:13px;color:#eaf0ff;opacity:.9}
    .stat-value{font-size:18px;font-weight:800;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .stat-note{font-size:12px;color:var(--muted)}

    /* أفضل الأقسام لكل مركز (بطاقات) */
    .best-dept-grid{
      display:grid; gap:16px;
      grid-template-columns:repeat(2,minmax(280px,1fr));
    }
    @media (max-width:900px){ .best-dept-grid{grid-template-columns:1fr} }
    .best-card{
      padding:14px;border-radius:16px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.10); box-shadow:var(--shadow);
    }
    .best-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
    .best-left{display:flex;align-items:center;gap:10px}
    .rank-badge{width:30px;height:30px;border-radius:10px;display:grid;place-items:center;background:rgba(255,255,255,.10);border:1px solid var(--stroke)}
    .chip{
      border:1px solid var(--stroke); background:rgba(255,255,255,.08); padding:4px 8px; border-radius:999px;
      font-weight:800; font-size:12px; color:#fff
    }
    .dept-list{display:grid;gap:8px}
    .dept-row{
      display:flex;align-items:center;gap:8px; padding:8px 10px; border-radius:12px;
      background:rgba(255,255,255,.08); border:1px solid var(--stroke)
    }
    .dept-row i{color:var(--accent)}
    .dept-name{font-size:13px}
    .dept-val{margin-right:auto}

    /* نافذة الأقسام */
    .modal-overlay{position:fixed;inset:0;display:none;z-index:1000;background:rgba(0,8,30,.78);padding:18px;overflow:auto}
    .modal{max-width:980px;margin:20px auto;padding:18px}
    .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .close-btn{width:40px;height:40px;display:grid;place-items:center;border-radius:50%;
      background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:#fff;cursor:pointer}
    .departments-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:6px}
    .department-card{background:rgba(255,255,255,.08);border:1px solid var(--stroke);padding:12px;border-radius:14px;text-align:center}
    .department-icon{font-size:1.6rem;color:var(--accent);margin-bottom:.45rem}
    .department-percentage{font-size:1.2rem;color:var(--accent);font-weight:800}
    .department-performance{font-size:.85rem;margin-top:4px}
    .above{color:#c8ffb7}.below{color:#ffe29b}
  </style>
</head>
<body>
  <!-- خلفية متحركة -->
  <div class="bg-grid"></div>
  <div class="orb o1"></div>
  <div class="orb o2"></div>

  <div class="container">
    <!-- رأس -->
    <div class="header panel">
      <div class="title">مؤشرات الأداء الشهرية <span class="accent">|</span> <span id="currentDate" class="badge"></span></div>
      <div class="badges">
        <div class="badge"><i class="fa-solid fa-bullseye"></i>&nbsp;الهدف اليومي: <span id="dailyBadge"></span></div>
        <div class="badge"><i class="fa-solid fa-gauge"></i>&nbsp;المستهدف التراكمي اليوم: <span id="cumBadge"></span></div>
      </div>
    </div>

    <!-- شبكة المراكز -->
    <div class="malls-grid" id="mallsGrid">
      <div class="mall-card" data-mall="ansar">
        <i class="fa-solid fa-city mall-icon"></i>
        <h2>الأنصار مول</h2>
        <h1><span class="mall-percentage">11.66</span>%</h1>
        <div class="performance-status"></div>
      </div>

      <div class="mall-card" data-mall="abyat">
        <i class="fa-solid fa-house-chimney mall-icon"></i>
        <h2>أبيات عسير</h2>
        <h1><span class="mall-percentage">10.76</span>%</h1>
        <div class="performance-status"></div>
      </div>

      <span class="grid-divider" aria-hidden="true"></span>

      <div class="mall-card" data-mall="fourpark">
        <i class="fa-solid fa-parking mall-icon"></i>
        <h2>فور بارك</h2>
        <h1><span class="mall-percentage">7.05</span>%</h1>
        <div class="performance-status"></div>
      </div>

      <div class="mall-card" data-mall="arabplaza">
        <i class="fa-solid fa-building mall-icon"></i>
        <h2>العرب بلازا</h2>
        <h1><span class="mall-percentage">20.42</span>%</h1>
        <div class="performance-status"></div>
      </div>
    </div>

    <!-- المؤشرات الإضافية (أربع بطاقات فقط) -->
    <h3 class="section-title"><i class="fa-solid fa-chart-line"></i> مؤشرات إضافية</h3>
    <div class="extras-cards" id="extraCards"></div>

    <!-- أفضل الأقسام لكل مركز (بطاقات) -->
    <h3 class="section-title"><i class="fa-solid fa-star"></i> أفضل الأقسام على مستوى كل مركز</h3>
    <div class="best-dept-grid" id="bestDeptGrid"></div>
  </div>

  <!-- نافذة الأقسام -->
  <div class="modal-overlay" id="modal">
    <div class="panel modal">
      <div class="hdr">
        <h3 class="title" id="modalTitle">تفاصيل المركز</h3>
        <button class="close-btn" id="closeModal"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="departments-grid" id="departmentsContainer"></div>
    </div>
  </div>

  <script>
    // ============ بيانات الأقسام ============
    const mallsData = {
      ansar: {
        title: "الأنصار مول",
        departments: [
          { name: "المفروشات", percentage: 9.14, icon: "fa-couch" },
          { name: "المنزلية", percentage: 15.75, icon: "fa-home" },
          { name: "الملابس الرجالية", percentage: 7.82, icon: "fa-shirt" },
          { name: "الملابس النسائية", percentage: 12.45, icon: "fa-person-dress" },
          { name: "الملابس الولادي", percentage: 13.69, icon: "fa-child" },
          { name: "العطور", percentage: 11.87, icon: "fa-spray-can-sparkles" },
          { name: "الأحذية", percentage: 16.26, icon: "fa-shoe-prints" },
          { name: "الألعاب", percentage: 7.40, icon: "fa-puzzle-piece" },
          { name: "الرياضة و الجاكت", percentage: 13.70, icon: "fa-futbol" },
          { name: "التخفيضات", percentage: 14.45, icon: "fa-tags" },
          { name: "سيفورا", percentage: 14.19, icon: "fa-wand-magic-sparkles" },
          { name: "المكتبة والشنط", percentage: 5.57, icon: "fa-pen" }
        ]
      },
      fourpark: {
        title: "فور بارك",
        departments: [
          { name: "المفروشات", percentage: 6.41, icon: "fa-couch" },
          { name: "المنزلية", percentage: 14.82, icon: "fa-home" }
        ]
      },
      abyat: {
        title: "أبيات عسير",
        departments: [
          { name: "المفروشات", percentage: 19.47, icon: "fa-couch" },
          { name: "المنزلية", percentage: 20.64, icon: "fa-home" },
          { name: "الملابس الرجالية", percentage: 11.49, icon: "fa-shirt" },
          { name: "الملابس النسائية", percentage: 7.86, icon: "fa-person-dress" },
          { name: "الملابس الولادي", percentage: 2.43, icon: "fa-child" },
          { name: "الملابس البناتي", percentage: 4.65, icon: "fa-person-dress" },
          { name: "الأحذية", percentage: 10.16, icon: "fa-shoe-prints" },
          { name: "الألعاب", percentage: 7.14, icon: "fa-puzzle-piece" },
          { name: "العطور", percentage: 10.11, icon: "fa-spray-can-sparkles" },
          { name: "المواليد", percentage: 6.61, icon: "fa-baby" }
        ]
      },
      arabplaza: {
        title: "العرب بلازا",
        departments: [
      { name: "المفروشات", percentage:21.78, icon: "fa-couch" },
          { name: "المنزلية", percentage: 18.48, icon: "fa-home" },
          { name: "ألعاب", percentage: 13.11, icon: "fa-puzzle-piece" }
        ]
      }
    };

    // ============ أدوات مساعدة ============
    const fmt = (n, d=2) => (isFinite(n) ? (+n).toFixed(d) : '');

    /* حساب الهدف حسب عدد أيام الشهر */
    function getMonthDays(d=new Date()){
      return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
    }
    function getDailyTarget(d=new Date()){
      return +(100 / getMonthDays(d)).toFixed(5);
    }
    function getCumulativeTarget(d=new Date()){
      return +(((100 / getMonthDays(d)) * d.getDate()).toFixed(2));
    }

    /* الهيدر */
    function updateHeader() {
      const now = new Date();
      const options = { month: 'long', day: 'numeric', year: 'numeric' };
      document.getElementById('currentDate').textContent = new Intl.DateTimeFormat('ar', options).format(now);
      document.getElementById('dailyBadge').textContent = fmt(getDailyTarget(now), 5) + '%';
      document.getElementById('cumBadge').textContent   = fmt(getCumulativeTarget(now), 2) + '%';
    }

    /* تحديث حالة كل بطاقة (مقارنة بالتراكمي) */
    function updatePerformance() {
      const target = getCumulativeTarget();
      document.querySelectorAll('.mall-card').forEach(card => {
        const pctEl = card.querySelector('.mall-percentage');
        const statusEl = card.querySelector('.performance-status');
        if(!pctEl || !statusEl) return;
        const current = parseFloat(pctEl.textContent);
        const diff = +(current - target).toFixed(2);
        statusEl.textContent = `${Math.abs(diff)}% ${diff >= 0 ? 'أعلى من المخطط' : 'أقل من المخطط'}`;
        statusEl.className = `performance-status ${diff >= 0 ? 'above-target' : 'below-target'}`;
      });
    }

    /* بطاقات مؤشرات إضافية (أربع فقط) */
    function buildExtraCards(){
      const target = getCumulativeTarget();
      const centers = Array.from(document.querySelectorAll('.mall-card')).map(card=>({
        id: card.dataset.mall,
        name: card.querySelector('h2').textContent.trim(),
        pct: parseFloat(card.querySelector('.mall-percentage').textContent)
      })).filter(c=>!isNaN(c.pct));

      const sorted = centers.slice().sort((a,b)=>b.pct - a.pct);
      const best = sorted[0];
      const worst = sorted[sorted.length-1];
      const avg = +(centers.reduce((a,c)=>a+c.pct,0)/centers.length).toFixed(2);

      const extra = document.getElementById('extraCards');
      extra.innerHTML = `
        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-trophy"></i></div>
          <div class="stat-info">
            <div class="stat-title">أفضل مركز أداءً</div>
            <div class="stat-value">${best.name} — ${fmt(best.pct)}%</div>
            <div class="stat-note">فارق عن التراكمي ${(best.pct-target>=0?'+':'-')}${fmt(Math.abs(best.pct-target))}%</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i class="fa-regular fa-circle-down"></i></div>
          <div class="stat-info">
            <div class="stat-title">أقل مركز أداءً</div>
            <div class="stat-value">${worst.name} — ${fmt(worst.pct)}%</div>
            <div class="stat-note">فارق عن التراكمي ${(worst.pct-target>=0?'+':'-')}${fmt(Math.abs(worst.pct-target))}%</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-gauge-high"></i></div>
          <div class="stat-info">
            <div class="stat-title">متوسط الإنجاز</div>
            <div class="stat-value">${fmt(avg)}%</div>
            <div class="stat-note">مقارنة بالتراكمي ${fmt(target)}%</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i class="fa-solid fa-layer-group"></i></div>
          <div class="stat-info">
            <div class="stat-title">المستهدف التراكمي اليوم</div>
            <div class="stat-value">${fmt(target)}%</div>
            <div class="stat-note">يتحدّث تلقائياً حسب عدد أيام الشهر</div>
          </div>
        </div>
      `;
    }

    /* بطاقات أفضل الأقسام لكل مركز (Top 3) */
    function buildBestDeptCards(){
      const target = getCumulativeTarget();
      const root = document.getElementById('bestDeptGrid');
      root.innerHTML = Object.entries(mallsData).map(([id,data])=>{
        const top3 = data.departments.slice().sort((a,b)=>b.percentage - a.percentage).slice(0,3);
        return `
          <div class="best-card">
            <div class="best-head">
              <div class="best-left">
                <div class="rank-badge"><i class="fa-solid fa-city"></i></div>
                <div>
                  <div style="font-weight:800">${data.title}</div>
                  <div style="font-size:12px;color:var(--muted)">أفضل 3 أقسام مقارنةً بالهدف ${fmt(target)}%</div>
                </div>
              </div>
              <div class="chip">Top 3</div>
            </div>
            <div class="dept-list">
              ${top3.map((d,i)=>{
                const p = +d.percentage; // لا قصّ للنسبة
                const diff = +(p - target).toFixed(2);
                const sign = diff>=0 ? '+' : '-';
                return `
                  <div class="dept-row">
                    <i class="fa-solid ${d.icon}"></i>
                    <div class="dept-name">${i+1}. ${d.name}</div>
                    <div class="chip dept-val">${fmt(p)}%</div>
                    <div class="chip">${sign}${fmt(Math.abs(diff))}%</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    /* نافذة الأقسام */
    function openModal(mallId) {
      const mall = mallsData[mallId];
      if(!mall) return;

      document.getElementById('modalTitle').textContent = mall.title;
      const target = getCumulativeTarget();

      const html = mall.departments.map(dept => {
        // >>> الإصلاح هنا: عرض النسبة الفعلية بدون حد أقصى 100%
        const p = +dept.percentage; // لا استخدام للـ clamp
        const diff = +(p - target).toFixed(2);
        const cls = diff >= 0 ? 'above' : 'below';
        return `
          <div class="department-card">
            <i class="fa-solid ${dept.icon} department-icon"></i>
            <h3>${dept.name}</h3>
            <div class="department-percentage">${fmt(p)}%</div>
            <div class="department-performance ${cls}">
              ${fmt(Math.abs(diff))}% ${diff >= 0 ? 'أعلى من المخطط' : 'أقل من المخطط'}
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('departmentsContainer').innerHTML = html;
      document.getElementById('modal').style.display = 'block';
    }
    function closeModal(){ document.getElementById('modal').style.display = 'none'; }

    /* تشغيل */
    document.addEventListener('DOMContentLoaded', () => {
      updateHeader();
      updatePerformance();
      buildExtraCards();
      buildBestDeptCards();

      // تفويض أحداث: أي نقرة على عنصر داخل .mall-card ستفتح المودال
      document.addEventListener('click', (e)=>{
        const card = e.target.closest('.mall-card');
        if(card){ openModal(card.dataset.mall); }
      });

      // زر الإغلاق
      document.getElementById('closeModal').addEventListener('click', closeModal);

      // إغلاق المودال بالنقر على الخلفية
      document.getElementById('modal').addEventListener('click', e => {
        if(e.target.id === 'modal') closeModal();
      });

      // ESC
      document.addEventListener('keyup', e => { if(e.key === 'Escape') closeModal(); });

      // تحديث دوري
      setInterval(() => {
        updateHeader();
        updatePerformance();
        buildExtraCards();
        buildBestDeptCards();
      }, 60000);
    });
  </script>
</body>
</html>
